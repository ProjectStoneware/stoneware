<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Stoneware</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; background: #fafafa; }
    input, select { padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; margin-top: 16px; }
    .stack { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    .muted { color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #eee; background: #f8f8f8; font-size: 12px; }
    .rbox { background: #0f0f0f; color: #f8f8f2; padding: 12px; border-radius: 8px; overflow-x: auto; }
    .ok { color: #006400; } .warn { color: #8B0000; }
    @media (max-width: 900px) { .stack { grid-template-columns: 1fr;} }
  </style>
</head>
<body>
  <h1>Stoneware MVP Spike</h1>

  <div class="row">
    <button id="hello">Say Hello</button>
    <button id="health">Health</button>
    <span id="status" class="pill muted">idle</span>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Upload CSV</h3>
    <div class="row">
      <input type="file" id="csv" accept=".csv" />
      <input type="text" id="dataname" placeholder="dataset name" value="my_data" />
      <button id="upload">Upload</button>
      <span id="upmsg" class="muted"></span>
    </div>
    <div class="row" style="margin-top:8px;">
      <label class="muted">Analyze dataset:</label>
      <select id="dataset">
        <option value="mtcars" selected>mtcars (built-in)</option>
        <option value="my_data">my_data (uploaded)</option>
      </select>
      <input id="formula" value="mpg~wt" />
      <button id="analyze">Analyze</button>
    </div>
  </div>

  <div id="panel-json" class="card" style="display:none;">
    <div class="muted">Raw JSON (debug)</div>
    <pre id="out" class="mono" style="white-space:pre-wrap;"></pre>
  </div>

  <div class="stack">
    <div class="card">
      <h3 style="margin-top:0;">Model summary</h3>
      <div id="summary" class="mono muted">Run an analysis to see results…</div>
      <div class="row" style="margin-top:8px;">
        <span class="pill" id="n"></span>
        <span class="pill" id="r2"></span>
        <span class="pill" id="adjr2"></span>
        <span class="pill" id="sigma"></span>
        <span class="pill" id="fstat"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Reproducibility Bridge</h3>
      <div class="rbox mono" id="rcode">fit <- lm(mpg~wt, data = mtcars)</div>
      <div class="row" style="margin-top:8px;">
        <button id="copy">Copy R code</button>
        <span class="muted" id="copyStatus"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Coefficients</h3>
    <table id="coef">
      <thead>
        <tr><th>Term</th><th>Estimate</th><th>Std. Error</th><th>t</th><th>p</th><th>95% CI</th></tr>
      </thead>
      <tbody id="coefBody">
        <tr><td colspan="6" class="muted">No results yet.</td></tr>
      </tbody>
    </table>
  </div>

<script>
const fmtNum = (x) => { if (x==null||Number.isNaN(x)) return "–"; const ax=Math.abs(x); if (ax>=1000||(ax>0&&ax<0.001)) return Number(x).toExponential(3); return Number(x).toFixed(4); };
const fmtP = (p) => (p<0.001 ? "<0.001" : Number(p).toExponential(2).replace("e-0","e-"));
const star = (p) => p<0.001 ? "***" : p<0.01 ? "**" : p<0.05 ? "*" : "";

const out = document.getElementById('out');
const statusEl = document.getElementById('status');
const panelJson = document.getElementById('panel-json');
const coefBody = document.getElementById('coefBody');
const summary = document.getElementById('summary');
const rcode = document.getElementById('rcode');

function setStatus(t, ok=true){ statusEl.textContent = t; statusEl.className = ok ? "pill ok" : "pill warn"; }

document.getElementById('hello').onclick = async () => {
  try { setStatus("hello…"); const d = await window.stoneware.fetchHello('David'); panelJson.style.display='block'; out.textContent = JSON.stringify(d,null,2); setStatus("ok"); }
  catch(e){ setStatus("hello failed", false); out.textContent = "Error: " + e; }
};

document.getElementById('health').onclick = async () => {
  try { setStatus("health…"); const d = await window.stoneware.fetchHealth(); panelJson.style.display='block'; out.textContent = JSON.stringify(d,null,2); setStatus("ok"); }
  catch(e){ setStatus("health failed", false); out.textContent = "Error: " + e; }
};

document.getElementById('analyze').onclick = async () => {
  const f = document.getElementById('formula').value || 'mpg~wt';
  const dataName = document.getElementById('dataset').value || 'mtcars';
  try {
    setStatus("analyzing…");
    const d = await window.stoneware.fetchLinear(f, dataName);
    panelJson.style.display='block';
    out.textContent = JSON.stringify(d, null, 2);

    const code = Array.isArray(d.r_code) ? d.r_code[0] : d.r_code; rcode.textContent = code || "";

    const ms = d.model_summary;
    const n = ms.n?.[0], r2 = ms.r2?.[0], adj = ms.adj_r2?.[0], sig = ms.sigma?.[0];
    const fval = ms.f_stat?.value?.[0], df1 = ms.f_stat?.df1?.[0], df2 = ms.f_stat?.df2?.[0], p = ms.f_stat?.p?.[0];
    summary.textContent = `n=${n}, R²=${fmtNum(r2)} (adj. ${fmtNum(adj)}), σ=${fmtNum(sig)}; F(${df1}, ${df2})=${fmtNum(fval)}, p=${fmtP(p)}`;
    document.getElementById('n').textContent = `n = ${n}`;
    document.getElementById('r2').textContent = `R² = ${fmtNum(r2)}`;
    document.getElementById('adjr2').textContent = `Adj R² = ${fmtNum(adj)}`;
    document.getElementById('sigma').textContent = `σ = ${fmtNum(sig)}`;
    document.getElementById('fstat').textContent = `F(${df1},${df2})=${fmtNum(fval)}, p=${fmtP(p)}`;

    coefBody.innerHTML = "";
    (ms.coefficients || []).forEach(c => {
      const tr = document.createElement('tr');
      const term = c.term?.[0], est = c.estimate?.[0], se = c.se?.[0], t = c.t?.[0], pv = c.p?.[0];
      const ciL = Array.isArray(c.ci) ? c.ci[0] : null;
      const ciH = Array.isArray(c.ci) ? c.ci[1] : null;
      tr.innerHTML = `
        <td>${term}</td>
        <td>${fmtNum(est)}</td>
        <td>${fmtNum(se)}</td>
        <td>${fmtNum(t)}</td>
        <td>${fmtP(pv)} <span class="muted">${star(pv)}</span></td>
        <td>${fmtNum(ciL)} to ${fmtNum(ciH)}</td>`;
      coefBody.appendChild(tr);
    });

    setStatus("ok");
  } catch(e) {
    setStatus("analyze failed", false);
    out.textContent = "Error: " + e;
  }
};

document.getElementById('upload').onclick = async () => {
  const file = document.getElementById('csv').files[0];
  const name = document.getElementById('dataname').value || 'my_data';
  const upmsg = document.getElementById('upmsg');
  if (!file) { upmsg.textContent = "Choose a CSV first."; return; }
  upmsg.textContent = "Uploading…";
  try {
    const res = await window.stoneware.uploadCSV(file, name);
    upmsg.textContent = `Uploaded "${res.name}" (${res.rows} rows, ${res.cols} cols)`;
    const ds = document.getElementById('dataset');
    if (![...ds.options].some(o => o.value === res.name)) {
      const opt = document.createElement('option'); opt.value = res.name; opt.text = `${res.name} (uploaded)`; ds.appendChild(opt);
    }
    ds.value = res.name;
  } catch (e) {
    upmsg.textContent = "Upload failed: " + e.message;
  }
};

document.getElementById('copy').onclick = async () => {
  try {
    await navigator.clipboard.writeText(document.getElementById('rcode').textContent || "");
    document.getElementById('copyStatus').textContent = "Copied!";
    setTimeout(() => document.getElementById('copyStatus').textContent = "", 1200);
  } catch {
    document.getElementById('copyStatus').textContent = "Copy failed";
    setTimeout(() => document.getElementById('copyStatus').textContent = "", 1200);
  }
};
</script>
</body>
</html>
